import { useState, useRef } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { 
  Volume2, 
  VolumeX, 
  Mic, 
  MicOff, 
  Play, 
  Pause, 
  RotateCcw,
  Languages,
  Headphones,
  Settings
} from "lucide-react";
import { toast } from "sonner";
import { voiceService } from "@/services/voiceService";

interface AudioGuide {
  id: string;
  title: string;
  titleHindi: string;
  titlePunjabi?: string;
  category: "health" | "farming" | "marketplace" | "navigation";
  duration: string;
  description: string;
  descriptionHindi: string;
  descriptionPunjabi?: string;
  priority: "high" | "medium" | "low";
  audioUrl?: string;
}

interface VoiceAssistantProps {
  currentData?: any;
  context?: "dashboard" | "health" | "map" | "indices" | "marketplace" | "voice" | "accessibility";
}

const VoiceAssistant = ({ currentData, context = "dashboard" }: VoiceAssistantProps) => {
  const [isListening, setIsListening] = useState(false);
  const [currentLanguage, setCurrentLanguage] = useState("hi"); // Hindi default
  const [audioEnabled, setAudioEnabled] = useState(true);
  const [currentlyPlaying, setCurrentlyPlaying] = useState<string | null>(null);
  const [voiceSpeed, setVoiceSpeed] = useState("normal");
  const audioRef = useRef<HTMLAudioElement | null>(null);

  const languages = [
    { code: "hi", name: "рд╣рд┐рдиреНрджреА (Hindi)", flag: "ЁЯЗоЁЯЗ│" },
    { code: "pa", name: "рикрй░риЬри╛римрйА (Punjabi)", flag: "ЁЯМ╛" },
    { code: "en", name: "English", flag: "ЁЯЗмЁЯЗз" }
  ];

  const audioGuides: AudioGuide[] = [
    {
      id: "welcome",
      title: "Welcome to Soil Saathi",
      titleHindi: "рд╕реЙрдпрд▓ рд╕рд╛рдереА рдореЗрдВ рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИ",
      titlePunjabi: "ри╕ри╛риЗри▓ ри╕ри╛риерйА ри╡ри┐рй▒риЪ ридрйБри╣ри╛рибри╛ ри╕ри╡ри╛риЧрид ри╣рйИ",
      category: "navigation",
      duration: "2:30",
      description: "Learn how to use the app",
      descriptionHindi: "рдРрдк рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╕реАрдЦреЗрдВ",
      descriptionPunjabi: "риРрик рижрйА ри╡ри░ридрйЛриВ ри╕ри┐рй▒риЦрйЛ",
      priority: "high"
    },
    {
      id: "health_analysis",
      title: "Understanding Your Field Health",
      titleHindi: "рдЕрдкрдиреЗ рдЦреЗрдд рдХреЗ рд╕реНрд╡рд╛рд╕реНрдереНрдп рдХреЛ рд╕рдордЭрдирд╛",
      category: "health",
      duration: "3:15",
      description: "Learn about NDVI and health indicators",
      descriptionHindi: "NDVI рдФрд░ рд╕реНрд╡рд╛рд╕реНрдереНрдп рд╕рдВрдХреЗрддрдХреЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдиреЗрдВ",
      priority: "high"
    },
    {
      id: "irrigation_guide",
      title: "Smart Irrigation Tips",
      titleHindi: "рд╕реНрдорд╛рд░реНрдЯ рд╕рд┐рдВрдЪрд╛рдИ рдпреБрдХреНрддрд┐рдпрд╛рдБ",
      category: "farming",
      duration: "4:20",
      description: "When and how to irrigate based on data",
      descriptionHindi: "рдбреЗрдЯрд╛ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдХрдм рдФрд░ рдХреИрд╕реЗ рд╕рд┐рдВрдЪрд╛рдИ рдХрд░реЗрдВ",
      priority: "medium"
    },
    {
      id: "marketplace_guide",
      title: "Finding the Right Products",
      titleHindi: "рд╕рд╣реА рдЙрддреНрдкрд╛рдж рдЦреЛрдЬрдирд╛",
      category: "marketplace",
      duration: "2:45",
      description: "How to buy recommended products",
      descriptionHindi: "рдЕрдиреБрд╢рдВрд╕рд┐рдд рдЙрддреНрдкрд╛рдж рдХреИрд╕реЗ рдЦрд░реАрджреЗрдВ",
      priority: "medium"
    }
  ];

  const contextualRecommendations: Record<string, string[]> = {
    dashboard: ["welcome", "health_analysis"],
    health: ["health_analysis", "irrigation_guide"],
    map: ["field_mapping", "navigation_guide"],
    indices: ["index_explanation", "data_interpretation"],
    marketplace: ["marketplace_guide", "product_selection"],
    voice: ["welcome", "health_analysis"],
    accessibility: ["welcome", "navigation_guide"]
  };

  const playAudio = async (audioId: string) => {
    try {
      if (!audioEnabled) {
        const message = currentLanguage === "hi" ? "рдСрдбрд┐рдпреЛ рдЕрдХреНрд╖рдо рд╣реИ" : 
                       currentLanguage === "pa" ? "риЖрибрйАриУ римрй░риж ри╣рйИ" : "Audio is disabled";
        toast.error(message);
        return;
      }

      if (currentlyPlaying === audioId) {
        // Stop current audio
        voiceService.stopAudio();
        setCurrentlyPlaying(null);
        return;
      }

      // Stop any currently playing audio
      voiceService.stopAudio();
      setCurrentlyPlaying(audioId);
      
      // Get the guide content
      const guide = audioGuides.find(g => g.id === audioId);
      if (guide) {
        let text = guide.title;
        let description = guide.description;
        
        if (currentLanguage === "hi") {
          text = guide.titleHindi;
          description = guide.descriptionHindi;
        } else if (currentLanguage === "pa") {
          text = guide.titlePunjabi || guide.title;
          description = guide.descriptionPunjabi || guide.description;
        }

        // Combine title and description for more comprehensive audio
        const fullText = `${text}. ${description}`;
        
        // Preprocess text for better pronunciation
        const processedText = voiceService.preprocessText(fullText, currentLanguage as 'en' | 'hi' | 'pa');

        // Use ElevenLabs for high-quality speech
        const speechRate = voiceSpeed === "slow" ? 0.8 : voiceSpeed === "fast" ? 1.2 : 1.0;
        
        const audioData = await voiceService.textToSpeech(processedText, {
          language: currentLanguage as 'en' | 'hi' | 'pa',
          speed: speechRate
        });

        await voiceService.playAudio(audioData.audioContent);
        
        const successMessage = currentLanguage === "hi" ? "рдСрдбрд┐рдпреЛ рдЪрд▓ рд░рд╣рд╛ рд╣реИ" :
                              currentLanguage === "pa" ? "риЖрибрйАриУ риЪрй▒ри▓ ри░ри┐ри╣ри╛ ри╣рйИ" : "Playing audio";
        toast.success(successMessage);
        
        setCurrentlyPlaying(null);
      }
    } catch (error) {
      console.error("Audio playback error:", error);
      const errorMessage = currentLanguage === "hi" ? "рдСрдбрд┐рдпреЛ рдЪрд▓рд╛рдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐" :
                          currentLanguage === "pa" ? "риЖрибрйАриУ риЪри▓ри╛риЙриг ри╡ри┐рй▒риЪ риЧри▓ридрйА" : "Error playing audio";
      toast.error(errorMessage);
      setCurrentlyPlaying(null);
    }
  };

  const stopAudio = () => {
    voiceService.stopAudio();
    setCurrentlyPlaying(null);
  };

  const startVoiceRecognition = () => {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      toast.error(currentLanguage === "hi" ? "рд╡реЙрдпрд╕ рд░рд┐рдХрдЧреНрдирд┐рд╢рди рд╕рдорд░реНрдерд┐рдд рдирд╣реАрдВ рд╣реИ" : "Voice recognition not supported");
      return;
    }

    try {
      const SpeechRecognition = (window as any).webkitSpeechRecognition || (window as any).SpeechRecognition;
      const recognition = new SpeechRecognition();
      
      recognition.lang = currentLanguage === "hi" ? "hi-IN" : 
                        currentLanguage === "pa" ? "pa-IN" : "en-US";
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onstart = () => {
        setIsListening(true);
        const message = currentLanguage === "hi" ? "рд╕реБрди рд░рд╣рд╛ рд╣реВрдБ..." :
                       currentLanguage === "pa" ? "ри╕рйБриг ри░ри┐ри╣ри╛ ри╣ри╛риВ..." : "Listening...";
        toast.success(message);
      };

      recognition.onresult = (event: any) => {
        const transcript = event.results[0][0].transcript;
        console.log("Voice command:", transcript);
        
        // Process voice commands
        processVoiceCommand(transcript.toLowerCase());
      };

      recognition.onerror = (event: any) => {
        console.error("Speech recognition error:", event.error);
        setIsListening(false);
        toast.error(currentLanguage === "hi" ? "рд╡реЙрдпрд╕ рд░рд┐рдХрдЧреНрдирд┐рд╢рди рддреНрд░реБрдЯрд┐" : "Voice recognition error");
      };

      recognition.onend = () => {
        setIsListening(false);
      };

      recognition.start();
    } catch (error) {
      console.error("Voice recognition setup error:", error);
      toast.error(currentLanguage === "hi" ? "рд╡реЙрдпрд╕ рд░рд┐рдХрдЧреНрдирд┐рд╢рди рд╢реБрд░реВ рдирд╣реАрдВ рд╣реЛ рд╕рдХрд╛" : "Could not start voice recognition");
    }
  };

  const processVoiceCommand = (command: string) => {
    // Simple voice command processing
    const commands = {
      hi: {
        "рд╕реНрд╡рд╛рд╕реНрдереНрдп рджрд┐рдЦрд╛рдУ": "health",
        "рдЦреЗрдд рджрд┐рдЦрд╛рдУ": "map", 
        "рдмрд╛рдЬрд╛рд░ рджрд┐рдЦрд╛рдУ": "marketplace",
        "рд╕рд╣рд╛рдпрддрд╛": "help"
      },
      en: {
        "show health": "health",
        "show map": "map",
        "show marketplace": "marketplace", 
        "help": "help"
      }
    };

    const langCommands = currentLanguage === "hi" ? commands.hi : commands.en;
    
    for (const [phrase, action] of Object.entries(langCommands)) {
      if (command.includes(phrase)) {
        toast.success(currentLanguage === "hi" ? `рдХрдорд╛рдВрдб рд╕рдордЭ рдЧрдпрд╛: ${phrase}` : `Command understood: ${phrase}`);
        // Here you would trigger the actual navigation or action
        break;
      }
    }
  };

  const filteredGuides = audioGuides.filter(guide => 
    contextualRecommendations[context]?.includes(guide.id) || 
    guide.category === context
  );

  return (
    <Card className="w-full">
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Headphones className="h-5 w-5 text-primary" />
          <span>{currentLanguage === "hi" ? "рд╡реЙрдпрд╕ рд╕рд╣рд╛рдпрдХ" : "Voice Assistant"}</span>
        </CardTitle>
      </CardHeader>
      <CardContent>
        <Tabs defaultValue="guides" className="w-full">
          <TabsList className="grid w-full grid-cols-3">
            <TabsTrigger value="guides" className="text-xs">
              {currentLanguage === "hi" ? "рдЧрд╛рдЗрдб" : "Guides"}
            </TabsTrigger>
            <TabsTrigger value="voice" className="text-xs">
              {currentLanguage === "hi" ? "рд╡реЙрдпрд╕" : "Voice"}
            </TabsTrigger>
            <TabsTrigger value="settings" className="text-xs">
              {currentLanguage === "hi" ? "рд╕реЗрдЯрд┐рдВрдЧреНрд╕" : "Settings"}
            </TabsTrigger>
          </TabsList>

          <TabsContent value="guides" className="space-y-3">
            <div className="flex items-center justify-between mb-4">
              <h4 className="font-medium">
                {currentLanguage === "hi" ? "рд╕реБрдЭрд╛рд╡рд┐рдд рдЧрд╛рдЗрдб" : "Recommended Guides"}
              </h4>
              <Badge variant="outline">
                {filteredGuides.length} {currentLanguage === "hi" ? "рдЙрдкрд▓рдмреНрдз" : "available"}
              </Badge>
            </div>

            <div className="space-y-2">
              {filteredGuides.map((guide) => (
                <div key={guide.id} className="p-3 border rounded-lg">
                  <div className="flex items-center justify-between mb-2">
                    <h5 className="font-medium text-sm">
                      {currentLanguage === "hi" ? guide.titleHindi : guide.title}
                    </h5>
                    <div className="flex items-center gap-2">
                      <Badge 
                        variant={guide.priority === "high" ? "destructive" : "secondary"}
                        className="text-xs"
                      >
                        {guide.priority === "high" ? "рдЙрдЪреНрдЪ" : guide.priority === "medium" ? "рдордзреНрдпрдо" : "рдХрдо"}
                      </Badge>
                      <span className="text-xs text-muted-foreground">{guide.duration}</span>
                    </div>
                  </div>
                  <p className="text-xs text-muted-foreground mb-3">
                    {currentLanguage === "hi" ? guide.descriptionHindi : guide.description}
                  </p>
                  <Button
                    size="sm"
                    variant={currentlyPlaying === guide.id ? "destructive" : "outline"}
                    onClick={() => currentlyPlaying === guide.id ? stopAudio() : playAudio(guide.id)}
                    className="w-full flex items-center gap-2"
                  >
                    {currentlyPlaying === guide.id ? (
                      <>
                        <Pause className="h-4 w-4" />
                        {currentLanguage === "hi" ? "рд░реЛрдХреЗрдВ" : "Stop"}
                      </>
                    ) : (
                      <>
                        <Play className="h-4 w-4" />
                        {currentLanguage === "hi" ? "рд╕реБрдиреЗрдВ" : "Play"}
                      </>
                    )}
                  </Button>
                </div>
              ))}
            </div>
          </TabsContent>

          <TabsContent value="voice" className="space-y-4">
            <div className="text-center space-y-4">
              <div className="flex items-center justify-center">
                <div className={`p-8 rounded-full border-4 transition-colors ${
                  isListening ? 'border-primary bg-primary/10 animate-pulse' : 'border-muted bg-muted/50'
                }`}>
                  {isListening ? (
                    <Mic className="h-12 w-12 text-primary" />
                  ) : (
                    <MicOff className="h-12 w-12 text-muted-foreground" />
                  )}
                </div>
              </div>
              
              <div>
                <h4 className="font-medium mb-2">
                  {currentLanguage === "hi" ? "рд╡реЙрдпрд╕ рдХрдорд╛рдВрдб" : "Voice Commands"}
                </h4>
                <p className="text-sm text-muted-foreground mb-4">
                  {isListening 
                    ? (currentLanguage === "hi" ? "рд╕реБрди рд░рд╣рд╛ рд╣реВрдБ... рдмреЛрд▓рд┐рдП" : "Listening... Please speak")
                    : (currentLanguage === "hi" ? "рдорд╛рдЗрдХ рдмрдЯрди рджрдмрд╛рдХрд░ рдмреЛрд▓реЗрдВ" : "Press mic button to speak")
                  }
                </p>
              </div>

              <Button
                size="lg"
                onClick={isListening ? () => setIsListening(false) : startVoiceRecognition}
                className="w-full"
                disabled={!audioEnabled}
              >
                {isListening ? (
                  <>
                    <MicOff className="h-5 w-5 mr-2" />
                    {currentLanguage === "hi" ? "рд░реЛрдХреЗрдВ" : "Stop Listening"}
                  </>
                ) : (
                  <>
                    <Mic className="h-5 w-5 mr-2" />
                    {currentLanguage === "hi" ? "рд╕реБрдирдирд╛ рд╢реБрд░реВ рдХрд░реЗрдВ" : "Start Listening"}
                  </>
                )}
              </Button>

              <div className="text-xs text-muted-foreground space-y-1">
                <p>{currentLanguage === "hi" ? "рдХрдорд╛рдВрдб рдЙрджрд╛рд╣рд░рдг:" : "Example commands:"}</p>
                <p>тАв "{currentLanguage === "hi" ? "рд╕реНрд╡рд╛рд╕реНрдереНрдп рджрд┐рдЦрд╛рдУ" : "Show health"}"</p>
                <p>тАв "{currentLanguage === "hi" ? "рдЦреЗрдд рджрд┐рдЦрд╛рдУ" : "Show map"}"</p>
                <p>тАв "{currentLanguage === "hi" ? "рд╕рд╣рд╛рдпрддрд╛" : "Help"}"</p>
              </div>
            </div>
          </TabsContent>

          <TabsContent value="settings" className="space-y-4">
            <div className="space-y-4">
              <div>
                <label className="text-sm font-medium mb-2 block">
                  <Languages className="h-4 w-4 inline mr-2" />
                  {currentLanguage === "hi" ? "рднрд╛рд╖рд╛" : "Language"}
                </label>
                <Select value={currentLanguage} onValueChange={setCurrentLanguage}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {languages.map((lang) => (
                      <SelectItem key={lang.code} value={lang.code}>
                        <span className="flex items-center gap-2">
                          <span>{lang.flag}</span>
                          <span>{lang.name}</span>
                        </span>
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div>
                <label className="text-sm font-medium mb-2 block">
                  <Settings className="h-4 w-4 inline mr-2" />
                  {currentLanguage === "hi" ? "рдЧрддрд┐" : "Speed"}
                </label>
                <Select value={voiceSpeed} onValueChange={setVoiceSpeed}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="slow">
                      {currentLanguage === "hi" ? "рдзреАрдорд╛" : "Slow"}
                    </SelectItem>
                    <SelectItem value="normal">
                      {currentLanguage === "hi" ? "рд╕рд╛рдорд╛рдиреНрдп" : "Normal"}
                    </SelectItem>
                    <SelectItem value="fast">
                      {currentLanguage === "hi" ? "рддреЗрдЬрд╝" : "Fast"}
                    </SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div className="flex items-center justify-between">
                <label className="text-sm font-medium">
                  {currentLanguage === "hi" ? "рдСрдбрд┐рдпреЛ рд╕рдХреНрд╖рдо" : "Audio Enabled"}
                </label>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setAudioEnabled(!audioEnabled)}
                  className="flex items-center gap-2"
                >
                  {audioEnabled ? (
                    <>
                      <Volume2 className="h-4 w-4" />
                      {currentLanguage === "hi" ? "рдЪрд╛рд▓реВ" : "On"}
                    </>
                  ) : (
                    <>
                      <VolumeX className="h-4 w-4" />
                      {currentLanguage === "hi" ? "рдмрдВрдж" : "Off"}
                    </>
                  )}
                </Button>
              </div>

              <Button
                variant="outline"
                onClick={() => {
                  setCurrentLanguage("hi");
                  setVoiceSpeed("normal");
                  setAudioEnabled(true);
                  toast.success(currentLanguage === "hi" ? "рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рд░реАрд╕реЗрдЯ рд╣реЛ рдЧрдИрдВ" : "Settings reset");
                }}
                className="w-full flex items-center gap-2"
              >
                <RotateCcw className="h-4 w-4" />
                {currentLanguage === "hi" ? "рд░реАрд╕реЗрдЯ рдХрд░реЗрдВ" : "Reset Settings"}
              </Button>
            </div>
          </TabsContent>
        </Tabs>
      </CardContent>
    </Card>
  );
};

export default VoiceAssistant;